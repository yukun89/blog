摘要：系列文章主要介绍以下几个问题：

1.http连接如何使用TCP连接
2.TCP连接的时延、瓶颈和存在的障碍
3.HTTP连接的优化，并行链接，keep-alive（持久连接）和管道化连接
4.管理连接时应该做和不应该做得事情

本系列文章以《HTTP权威指南为参考》，同时结合相关的http（go语言）进行实例分析。

##1.TCP连接

几乎所有的HTTP连接都是TCP/IP承载的，http连接实际上就是TCP连接与其使用规则。

###1.1.TCP连接的可靠性

TCP连接的规则TCP会有序、误差错地承载HTTP数据

###1.2.TCP流是分段的，由IP分组发送

HTTP传输数据时，将数据以流的形式发送给一条打开的TCP连接，有序传输。TCP收到数据流之后，会对数据流进行分段拆分，封装在IP分组中进行传输。所有这些工作时TCP/IP协议层的内容，对HTTP透明。

一条HTTP连接，需要一条TCP连接来承载；而一条TCP传输，需要若干个IP包传输。

###1.3 保持TCP连接不断运行

TCP连接标示：<srcIP,srcPoint,desIP,desPoint>

其中TCP和IP分组如图所示。

###1.4 TCP 套接字编程

常见的TCP套接字interface 函数：

需要注意的是，TCP API隐藏了所有底层网络协议的握手细节，以及TCP数据流与IP分组之间的分段和重装细节。

##2 TCP连接的性能

HTTP事务的性能很大程度上取决于TCP性能。

###2.1 HTTP事务的时延

首先，回忆一下HTTP事务在串行模式下的时延。如下图所示：

除非client/server端超载，或者正在处理复杂动态资源，否则HTTP时延主要是由TCP网络延迟造成的。

HTTP事务的时延由一下流程构成：
`DNS解析>>建立连接>>传输请求报文>>事务处理>>报文回送` 
以上网络延迟的大小取决于硬件速度、服务器负载、报文尺寸、clien-server距离。

###2.2 性能聚焦

对HTTP程序员产生影响的TCP相关时延包括：

* TCP连接建立握手
* TCP慢启动拥塞控制
* 数据聚集的Nagle算法
* 用于捎带确认的TCP延迟确认算法
* time_wait时延和端口耗尽

###2.3 TCP连接的握手时延

TCP连接遵循`三次握手`原则，如果每次连接传输少量数据，那么交换分组的过程将严重降低HTTP性能。这个过程如下图所示。后续，我们将讨论如何通过重用TCP连接来减小这种TCP建立延时。

###2.4 延迟确认

TCP通过自身的确认机制保证数据的可靠性传输；为了提高性能，TCP采用延迟确认算法来combine若干个ack报文。但是HTTP的某类请求，具有双峰特性，这种应答行为降低了捎带信息的可能性——当需要有反方向的回传分组的时候，偏偏没有那么多。此时，延迟确认算法将产生较大的时延。为此，可以调整或者禁用延迟确认算法。

延迟确认算法会在一个特定的窗口时间（100~200ms）内将输出确认放在cache中，以寻找能够捎带它的输出数据分组；如果没找到，就将ack信息作为独立分组发送。

###2.5 TCP慢启动

TCP数据传输的性能还取决于TCP连接的使用期。TCP连接会随着时间进行自我“调谐”，最初将限制连接的最大传输速度，如果数据传输成功，会随着时间的推移提高传输速度。这就是“TCP慢启动”，用于防止因特网的突然过载和拥塞。具体可以参考“打开拥塞窗口”。

###2.6 Nagle算法与TCP_NODELAY

在上文中，我们通过TCP数据结构看到，数据部分的大小是没有限制的；但是，当数据部分很小时，将大大降低网络性能。Nagle算法，试图在发送一个分组之前，将大量TCP数据捆绑在一起，从而提高效率。Nagle鼓励发送全尺寸的段（Lan：1500B，Internet：~600B）。

Nagle算法可能导致的HTTP性能问题：
1）小的HTTP报文无法填满一个分组
2）与延迟算法的交互：

我们可以通过TCP_NODELAY参数来禁用Nagle算法。

###2.7 time_wait累积与端口耗尽

当某个TCP端点关闭TCP连接时，会在MEM中维护一个控制块，用于记录最近关闭连接的ip:port。这个信息仅仅会存在一小段时间（2MSL），确保不会在此期间建立新的具有相同ip:port的连接——因为分组会复制，如果来自之前连接的复制分组插入了具有相同连接值的新IP流，会破坏TCP数据。

使用time_wait防止端口号重用，在基准测试时，可能会产生端口耗尽的问题。即使没有端口耗尽问题，也需要小心存在大量连接处于打开状态的情况；或者为处于等待状态的连接分配了大量控制块的情况：这会减缓操作系统的运行速度。

（Q：为什么要设置time_wait机制）




 		
		





